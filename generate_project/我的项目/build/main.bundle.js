(()=>{function e(){const e=document.getElementById("markdown-input"),n=document.getElementById("html-output");if(!e||!n)return;const o=e.getBoundingClientRect();o.bottom>=0&&o.top<=window.innerHeight&&t()}function t(){const e=document.getElementById("markdown-input"),t=document.getElementById("html-output");if(!e||!t)return;let n=e.innerText.replace(/\\tilde\{([^}]*)\}/g,"\\widetilde{$1}").replace(/\\tilde\s+([a-zA-Z])/g,"\\widetilde{$1}");const o={};let a=0;n=n.replace(/(\\begin\{[a-zA-Z*]+\}[\s\S]*?\\end\{[a-zA-Z*]+\})|(\$\$[\s\S]*?\$\$)/g,(e=>{const t=e.match(/\\label\{([^}]*)\}/);return t?(a++,o[t[1]]=a,(e=e.replace(t[0],"")).replace(/(\$\$|\\end\{[a-zA-Z*]+\})$/,`\\tag{${a}}$1`)):e})),n=n.replace(/\\ref\{([^}]*)\}/g,((e,t)=>o[t]?o[t]:"?"));const r=marked.parse(n);t.innerHTML=r}function n(){const t=document.querySelector(".markdown-container");t&&t.addEventListener("scroll",function(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout((()=>e.apply(this,o)),t)}}(e,200))}marked.use({extensions:[{name:"mathInline",level:"inline",start:e=>e.match(/\$/)?.index,tokenizer(e,t){const n=/^\$([^$]+)\$/.exec(e);if(n)return{type:"mathInline",raw:n[0],text:n[1].trim()}},renderer(e){try{const t=e.text.replace(/\\tilde\{([^}]*)\}/g,"\\widetilde{$1}").replace(/\\hat\{([^}]*)\}/g,"\\widehat{$1}");return`<span data-md-type="math-inline">${katex.renderToString(t,{throwOnError:!1,strict:!1,macros:{"\\RR":"\\mathbb{R}","\\CC":"\\mathbb{C}","\\ZZ":"\\mathbb{Z}","\\NN":"\\mathbb{N}","\\QQ":"\\mathbb{Q}"}})}</span>`}catch(t){return console.error("Inline math rendering error:",t),`<span class="math-error">${e.raw}</span>`}}},{name:"mathBlock",level:"block",start:e=>e.match(/\$\$/)?.index,tokenizer(e,t){const n=/^\$\$([\s\S]*?)\$\$/.exec(e);if(n)return{type:"mathBlock",raw:n[0],text:n[1].trim()}},renderer(e){try{const t=e.text.replace(/\\tilde\{([^}]*)\}/g,"\\widetilde{$1}").replace(/\\hat\{([^}]*)\}/g,"\\widehat{$1}");return`<div data-md-type="math-block">${katex.renderToString(t,{displayMode:!0,throwOnError:!1,strict:!1,macros:{"\\RR":"\\mathbb{R}","\\CC":"\\mathbb{C}","\\ZZ":"\\mathbb{Z}","\\NN":"\\mathbb{N}","\\QQ":"\\mathbb{Q}"}})}</div>`}catch(t){return console.error("Block math rendering error:",t),`<div class="math-error">${e.raw}</div>`}}},{name:"highlight",level:"inline",start:e=>e.match(/==/)?.index,tokenizer(e,t){const n=/^==([^=]+)==/.exec(e);if(n)return{type:"highlight",raw:n[0],text:n[1].trim()}},renderer:e=>`<span class="highlight">${marked.parseInline(e.text)}</span>`},{name:"boldHighlight",level:"inline",start:e=>e.match(/==\*\*/)?.index,tokenizer(e,t){const n=/^\*\*==([^=]+)==\*\*/.exec(e);if(n)return{type:"boldHighlight",raw:n[0],text:n[1].trim()};const o=/^==\*\*([^=]+)\*\*==/.exec(e);return o?{type:"boldHighlight",raw:o[0],text:o[1].trim()}:void 0},renderer:e=>`<span class="highlight"><strong>${marked.parseInline(e.text)}</strong></span>`}]}),document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("upload-note-btn"),o=document.getElementById("upload-dialog"),a=document.getElementById("cancel-upload"),r=document.getElementById("file-input"),l=document.getElementById("confirm-upload"),i=document.getElementById("markdown-input"),d=document.getElementById("html-output"),c=document.getElementById("save-publish-btn"),s=document.getElementById("sidebar");i.style.display="block",function(){const e=document.getElementById("markdown-input");if(!e)return;const n=localStorage.getItem("markdownContent");n&&(e.innerText=n,t()),window.addEventListener("beforeunload",(()=>{localStorage.setItem("markdownContent",e.innerText)})),setInterval((()=>{localStorage.setItem("markdownContent",e.innerText)}),5e3)}(),d.style.display="block",t(),n();const m="true"===new URLSearchParams(window.location.search).get("editMode");if(e.addEventListener("click",(()=>{o.style.display="block"})),r.addEventListener("change",(e=>{const t=e.target.files[0];t&&t.name.endsWith(".md")?l.disabled=!1:l.disabled=!0})),l.addEventListener("click",(async()=>{const e=r.files[0];if(e){const t=new FileReader;t.onload=function(e){i.innerText=e.target.result,o.style.display="none"},t.readAsText(e),debouncedUpdateLineNumbers()}})),a.disabled=!1,a.addEventListener("click",(()=>{o.style.display="none"})),!i||!d)return void console.error("Required elements not found");if(m){const e=localStorage.getItem("editNoteId"),t=localStorage.getItem("editContent");e&&t&&(i.innerText=t,i.dispatchEvent(new Event("input")),c.textContent="保存修改",c.style.backgroundColor="#4CAF50")}else localStorage.removeItem("editMode"),localStorage.removeItem("editNoteId"),localStorage.removeItem("editContent");if(window.location.pathname.endsWith("index.html")&&i&&(i.style.display="block",d.style.display="block"),s&&document.querySelectorAll(".subcategory").forEach((e=>{if(e.dataset.initialized)return;const t=document.createElement("a"),n=e.closest(".category").querySelector(".category-title").textContent;for(t.href=`notes/${encodeURIComponent(n)}/${encodeURIComponent(e.textContent)}/contents.html`,t.style.textDecoration="none",t.style.color="inherit",t.style.display="block",t.style.width="100%",t.style.height="100%";e.firstChild;)t.appendChild(e.firstChild);e.appendChild(t),e.addEventListener("click",(async function(e){const t=this.querySelector("a");t&&(window.location.href=t.href),document.querySelectorAll(".subcategory").forEach((e=>e.classList.remove("active"))),this.classList.add("active"),this.closest(".category").querySelector(".category-title").textContent,this.textContent,localStorage.setItem("selectedCategory",this.dataset.id),document.getElementById("markdown-input")&&(document.getElementById("markdown-input").style.display="block",document.getElementById("html-output").style.display="block")})),e.dataset.initialized=!0})),window.addEventListener("popstate",(()=>{window.location.pathname.endsWith("index.html")&&i&&(i.style.display="block",d.style.display="block")})),i&&d){"true"===localStorage.getItem("editMode")&&(i.innerText=localStorage.getItem("editContent")||"");const e=i.innerText.replace(/\\tilde\{([^}]*)\}/g,"\\widetilde{$1}"),t=marked.parse(e);d.innerHTML=t;const n=localStorage.getItem("navWidth");n&&(s.style.width=n),new ResizeObserver((e=>{for(let t of e){const e=t.contentRect.width+"px";localStorage.setItem("navWidth",e)}})).observe(s);const o=localStorage.getItem("selectedCategory");if(o){const e=document.querySelector(`.subcategory[data-id="${o}"]`);e&&e.click()}}document.querySelectorAll(".subcategory").forEach(((e,t)=>{e.dataset.id=`category-${t}`}));let u;i.addEventListener("input",(()=>{clearTimeout(u),u=setTimeout(t,300)}));const y=document.getElementById("category-dialog"),g=document.getElementById("main-category"),h=document.getElementById("sub-category"),p=document.getElementById("confirm-save"),b=document.getElementById("cancel-save");function x(e){h.innerHTML="";e.parentElement.querySelectorAll(".subcategory").forEach((e=>{const t=document.createElement("option");t.value=e.textContent,t.textContent=e.textContent,h.appendChild(t)}))}c.addEventListener("click",(()=>{if(new Blob([i.innerText]).size>5242880)return void alert("内容过大，请分成多个笔记保存");if(new Blob([LZString.compressToUTF16(i.innerText)]).size>2097152)return void alert("压缩后内容仍然过大，请分成多个笔记保存");y.style.display="block",function(){g.innerHTML="",h.innerHTML="";const e=document.querySelectorAll(".category-title");e.forEach(((e,t)=>{const n=document.createElement("option");n.value=e.textContent,n.textContent=e.textContent,g.appendChild(n),0===t&&x(e)})),g.addEventListener("change",(t=>{x(e[t.target.selectedIndex])}))}()})),b.addEventListener("click",(()=>{y.style.display="none"})),p.addEventListener("click",(async()=>{const e=g.value,t=h.value,n=i.innerText.match(/^#\s+(.+)/m),o=n?n[1].trim():"未命名笔记";y.style.display="none";try{const n="true"===localStorage.getItem("editMode"),a=localStorage.getItem("editNoteId"),r=n?"http://localhost:3000/api/update":"http://localhost:3000/api/save",l=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8",Accept:"application/json"},body:JSON.stringify({compressed:!0,id:a,category:e,subcategory:t,title:o,content:d.innerHTML,markdownContent:i.innerText||"",savePath:`${e}/${t}`,isEdit:n})}),c=await l.json();if(!c.success)throw new Error(c.message);{const n=document.createElement("div");n.textContent=c.message,n.style.position="fixed",n.style.bottom="20px",n.style.left="50%",n.style.transform="translateX(-50%)",n.style.backgroundColor="#4caf50",n.style.color="white",n.style.padding="12px 24px",n.style.borderRadius="25px",n.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",n.style.zIndex="1000",n.style.animation="fadeInOut 3s ease-in-out",document.body.appendChild(n);const o=document.querySelector(`a[href*="${e}/${t}/contents.html"]`);if(o){const e=async()=>{try{const e=await fetch(o.href),t=new DOMParser,n=t.parseFromString(await e.text(),"text/html").getElementById("note-list"),a=document.getElementById("note-list");if(a){const e=n.innerHTML;a.innerHTML=e,document.dispatchEvent(new Event("contentUpdated"))}}catch(e){console.error("刷新笔记列表失败:",e)}};e(),setTimeout(e,3e3)}setTimeout((()=>{n.remove()}),3e3)}}catch(e){const t=document.createElement("div");t.textContent="保存失败："+e.message,t.style.position="fixed",t.style.bottom="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.backgroundColor="#f44336",t.style.color="white",t.style.padding="12px 24px",t.style.borderRadius="25px",t.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",t.style.zIndex="1000",t.style.animation="fadeInOut 3s ease-in-out",document.body.appendChild(t),setTimeout((()=>{t.remove()}),3e3)}}))}))})();